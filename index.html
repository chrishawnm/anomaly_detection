<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Detection Data Generator</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- noUiSlider for the Double Sided Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
        }
        .slider-styled {
            height: 10px;
        }
        .slider-styled .noUi-connect {
            background: #3b82f6;
        }
        .noUi-handle {
            background: #60a5fa;
            border: 2px solid #fff;
            box-shadow: none;
            border-radius: 50%;
            cursor: grab;
        }
        .noUi-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="p-6 font-sans">

    <div class="max-w-7xl mx-auto">
        <!-- Header with Context Box -->
        <header class="mb-8 border-b border-slate-700 pb-6 flex flex-col lg:flex-row justify-between items-start lg:items-end gap-6">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Anomaly Detection Playground</h1>
                <p class="text-slate-400 mt-2">Generate 3 years of data, inject anomalies, and filter the view.</p>
                <a href="https://github.com/chrishawnm/anomaly_detection" target="_blank" class="inline-flex items-center mt-3 text-sm text-blue-400 hover:text-blue-300 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
                    View on GitHub
                </a>
            </div>
            
            <!-- New Context Box -->
            <div class="bg-slate-800 border-l-4 border-blue-500 p-4 rounded shadow-lg max-w-lg">
                <h3 class="text-white font-bold text-sm mb-1">What am I looking at?</h3>
                <p class="text-xs text-slate-300 leading-relaxed">
                    Real-world data is messy. <strong>Standard Z-Score</strong> uses Mean/StdDev, which gets distorted by massive outliers ("Whales"), often hiding smaller but critical issues. 
                    <br><br>
                    <strong>Modified Z-Score</strong> uses Median/MAD, which ignores the Whales to reliably catch the "Burnt Toast" (small anomalies). Use the slider below to see how "Context" changes detection!
                </p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Controls Sidebar -->
            <div class="bg-slate-800 p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-xl font-semibold mb-4 text-white">Generators</h2>
                
                <!-- Method Selector (NEW) -->
                <div class="mb-6 border-b border-slate-700 pb-6">
                    <label class="block text-sm font-bold mb-2 text-yellow-400">Detection Method</label>
                    <select id="detectionMethod" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-2 text-white cursor-pointer hover:bg-slate-600 transition">
                        <option value="modified">Modified Z-Score (Robust)</option>
                        <option value="standard">Standard Z-Score (Fragile)</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-2" id="methodDesc">
                        Uses <strong>Median & MAD</strong> calculated from the <strong>Current View</strong>.
                    </p>
                </div>

                <!-- Trend Control -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-slate-300">Yearly Growth Trend (%)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="trendSlider" min="-20" max="50" value="5" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <span id="trendValue" class="text-blue-400 font-bold w-12 text-right">5%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Simulates gradual business growth.</p>
                </div>

                <!-- Anomaly Count -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-slate-300">Number of Anomalies</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="anomalyCountSlider" min="0" max="50" value="5" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <span id="anomalyCountValue" class="text-red-400 font-bold w-12 text-right">5</span>
                    </div>
                </div>

                <!-- Anomaly Magnitude -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-slate-300">Anomaly Size (Multiplier)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="anomalySizeSlider" min="2" max="20" value="10" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <span id="anomalySizeValue" class="text-red-400 font-bold w-12 text-right">10x</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Multiplier of standard noise (The Whale factor).</p>
                </div>

                <!-- Detection Threshold (Visual Only) -->
                <div class="mb-6 border-t border-slate-600 pt-4">
                    <label class="block text-sm font-medium mb-2 text-green-300">Alert Threshold</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="zThreshold" value="3.5" step="0.5" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white">
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Points above this are colored Red.</p>
                </div>

                <button id="regenerateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Regenerate Data
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- Chart Container -->
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg relative" style="height: 500px;">
                    <canvas id="mainChart"></canvas>
                </div>

                <!-- Double Sided Slider -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm text-slate-400">Start Date: <span id="dateStartDisplay" class="text-white font-mono"></span></span>
                        <span class="text-sm text-slate-400">End Date: <span id="dateEndDisplay" class="text-white font-mono"></span></span>
                    </div>
                    <div id="dateSlider" class="slider-styled mt-2 mb-4"></div>
                    <p class="text-xs text-center text-slate-500">
                        <span class="text-blue-400 font-bold">New Logic:</span> Dragging these handles will Recalculate Anomaly Scores based on the 
                        <span class="text-blue-400 font-bold">visible data only</span>.
                    </p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_DAYS = 365 * 3; // 3 Years
        const BASE_VALUE = 50;
        const BASE_NOISE = 5; // Standard deviation of the noise

        // Global State
        let allData = [];
        let chartInstance = null;
        let dateSlider = document.getElementById('dateSlider');

        // --- MATH UTILITIES (The brains) ---
        
        // Calculate Mean
        function getMean(values) {
            if (values.length === 0) return 0;
            return values.reduce((sum, val) => sum + val, 0) / values.length;
        }

        // Calculate Standard Deviation
        function getStdDev(values, mean) {
            if (values.length === 0) return 0;
            const squareDiffs = values.map(value => Math.pow(value - mean, 2));
            const avgSquareDiff = getMean(squareDiffs);
            return Math.sqrt(avgSquareDiff);
        }
        
        // Calculate Median
        function getMedian(values) {
            if(values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // Calculate MAD (Median Absolute Deviation)
        function getMAD(values, median) {
            if(values.length === 0) return 0;
            const deviations = values.map(v => Math.abs(v - median));
            return getMedian(deviations);
        }

        // --- CORE LOGIC ---

        // 1. Generate Raw Data (Independent of Anomaly Method)
        function generateRawData() {
            const trendPercent = parseFloat(document.getElementById('trendSlider').value);
            const anomalyCount = parseInt(document.getElementById('anomalyCountSlider').value);
            const anomalySize = parseFloat(document.getElementById('anomalySizeSlider').value);
            
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 3);

            allData = [];

            // A. Base Data Loop
            for (let i = 0; i < TOTAL_DAYS; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                // Trend Logic
                const growthFactor = 1 + (trendPercent / 100) * (i / TOTAL_DAYS);
                
                // Add Random Noise
                const noise = (Math.random() - 0.5) * (BASE_NOISE * 2);
                
                let value = (BASE_VALUE * growthFactor) + noise;
                value = Math.max(0, value);

                allData.push({
                    x: currentDate.getTime(),
                    y: value,
                    isAnomaly: false
                });
            }

            // B. Inject Large Anomalies (The Whales)
            // Controlled by the slider
            for (let k = 0; k < anomalyCount; k++) {
                const randomIndex = Math.floor(Math.random() * TOTAL_DAYS);
                const direction = Math.random() > 0.2 ? 1 : -1; 
                allData[randomIndex].y += (BASE_NOISE * anomalySize * direction);
                allData[randomIndex].isAnomaly = true;
            }

            // C. Inject Small "Burnt Toast" Anomalies
            const smallAnomalyCount = 10;
            for (let j = 0; j < smallAnomalyCount; j++) {
                const randomIndex = Math.floor(Math.random() * TOTAL_DAYS);
                const direction = Math.random() > 0.5 ? 1 : -1;
                // Multiplier 4x - 6x (Smaller than the whales, but statistically significant)
                const multiplier = 4 + Math.random() * 2; 
                allData[randomIndex].y += (BASE_NOISE * multiplier * direction);
            }

            // Initial math calc on full range
            // We use a timeout to ensure chart is ready
            setTimeout(() => {
                recalculateScoresOnWindow(0, TOTAL_DAYS);
            }, 100);
        }

        // 2. Recalculate Scores based on a specific WINDOW (Slider)
        function recalculateScoresOnWindow(startIndex, endIndex) {
            const method = document.getElementById('detectionMethod').value;
            const threshold = parseFloat(document.getElementById('zThreshold').value);
            
            // 1. Isolate the "View Window" data
            // We only look at stats for the currently visible points
            const windowDataPoints = allData.slice(startIndex, endIndex);
            const windowValues = windowDataPoints.map(d => d.y);
            
            let stats = {};

            // 2. Calculate Stats ONLY for this window
            if (method === 'standard') {
                stats.mean = getMean(windowValues);
                stats.stdDev = getStdDev(windowValues, stats.mean);
            } else {
                stats.median = getMedian(windowValues);
                stats.mad = getMAD(windowValues, stats.median);
                stats.constant = 0.6745;
            }

            // 3. Apply Scores to the window data
            // Note: We also update the global array, but only the visible ones "matter" visually
            windowDataPoints.forEach(point => {
                let score = 0;

                if (method === 'standard') {
                    if (stats.stdDev !== 0) {
                        score = (point.y - stats.mean) / stats.stdDev;
                    }
                } else {
                    if (stats.mad !== 0) {
                        score = (stats.constant * (point.y - stats.median)) / stats.mad;
                    }
                }

                point.zScore = Math.abs(score); 
                point.color = point.zScore > threshold ? '#ef4444' : '#3b82f6';
            });

            // 4. Update the Chart
            if(chartInstance) {
                // We only render the window data
                chartInstance.data.datasets[0].data = windowDataPoints;
                chartInstance.update();
            }
        }

        // --- CHARTING ---
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'scatter', 
                data: {
                    datasets: [{
                        label: 'Server CPU Load',
                        data: [],
                        backgroundColor: (ctx) => {
                            const raw = ctx.raw;
                            return raw ? raw.color : '#3b82f6'; 
                        },
                        pointRadius: (ctx) => {
                            const raw = ctx.raw;
                            return raw && raw.color === '#ef4444' ? 6 : 3;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'CPU Load (%)', color: '#94a3b8' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    const method = document.getElementById('detectionMethod').value;
                                    const labelType = method === 'standard' ? 'Std Z' : 'Mod Z';
                                    
                                    let label = `Value: ${point.y.toFixed(2)}`;
                                    label += ` | ${labelType}: ${point.zScore.toFixed(2)}`;
                                    
                                    if(point.zScore > parseFloat(document.getElementById('zThreshold').value)) {
                                        label += ` (ALERT!)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- SLIDER LOGIC ---
        function initSlider() {
            noUiSlider.create(dateSlider, {
                start: [0, TOTAL_DAYS],
                connect: true,
                range: { 'min': 0, 'max': TOTAL_DAYS },
                step: 1,
                behaviour: 'drag',
            });

            dateSlider.noUiSlider.on('update', function (values, handle) {
                const startIndex = Math.round(values[0]);
                const endIndex = Math.round(values[1]);
                
                // Update text
                if(allData.length > 0) {
                    const safeEnd = Math.min(endIndex, allData.length - 1) || 0;
                    const safeStart = Math.min(startIndex, allData.length - 1);

                    const startTs = allData[safeStart].x;
                    const endTs = allData[safeEnd].x; 
                    document.getElementById('dateStartDisplay').innerText = new Date(startTs).toLocaleDateString();
                    document.getElementById('dateEndDisplay').innerText = new Date(endTs).toLocaleDateString();
                }

                // TRIGGER RECALCULATION ON ZOOM
                // This makes the anomaly detection "Context Aware" of the slider range
                recalculateScoresOnWindow(startIndex, endIndex);
            });
        }

        // --- EVENT LISTENERS ---
        // UI Value Updates
        document.getElementById('trendSlider').addEventListener('input', (e) => document.getElementById('trendValue').innerText = e.target.value + '%');
        document.getElementById('anomalyCountSlider').addEventListener('input', (e) => document.getElementById('anomalyCountValue').innerText = e.target.value);
        document.getElementById('anomalySizeSlider').addEventListener('input', (e) => document.getElementById('anomalySizeValue').innerText = e.target.value + 'x');

        // Method Switch Description
        document.getElementById('detectionMethod').addEventListener('change', (e) => {
            const desc = document.getElementById('methodDesc');
            if(e.target.value === 'standard') {
                desc.innerHTML = `Uses <strong>Mean & StdDev</strong>. <span class="text-red-400">Warning:</span> A large "Whale" will inflate the StdDev, causing smaller anomalies to be ignored.`;
            } else {
                desc.innerHTML = `Uses <strong>Median & MAD</strong> calculated from the <strong>Current View</strong>.`;
            }
            // Trigger update based on current slider position
            if (dateSlider && dateSlider.noUiSlider) {
                const sliderRange = dateSlider.noUiSlider.get();
                recalculateScoresOnWindow(Math.round(sliderRange[0]), Math.round(sliderRange[1]));
            }
        });

        // Regenerate everything (New Data + New Math)
        document.getElementById('regenerateBtn').addEventListener('click', () => {
            generateRawData();
        });
        
        // Threshold Update
        document.getElementById('zThreshold').addEventListener('input', () => {
            if (dateSlider && dateSlider.noUiSlider) {
                const sliderRange = dateSlider.noUiSlider.get();
                recalculateScoresOnWindow(Math.round(sliderRange[0]), Math.round(sliderRange[1]));
            }
        });

        // --- INITIALIZATION ---
        initChart();
        generateRawData();
        initSlider();

    </script>
</body>
</html>
